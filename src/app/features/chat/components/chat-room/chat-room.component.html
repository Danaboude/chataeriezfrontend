<!-- User Selection Modal -->
<div *ngIf="showUserSelection"
  class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm transition-opacity">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md animate-fade-in-up relative">
    <!-- Logo Section -->
    <div class="flex justify-center py-8">
      <div class="w-24 h-24 rounded-full bg-[#1e45F3] flex items-center justify-center shadow-lg border-4 border-white">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-white" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
        </svg>
      </div>
    </div>

    <div class="px-8 text-center bg-white pb-6">
      <h2 class="text-2xl font-bold text-gray-900">Welcome</h2>
      <p class="text-sm text-gray-500 mt-2">Choose a profile to start chatting</p>

      <!-- Error Message Display -->
      <div *ngIf="errorMessage"
        class="mt-4 p-3 bg-red-50 text-red-600 text-sm rounded-lg border border-red-100 flex items-center justify-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd"
            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
            clip-rule="evenodd" />
        </svg>
        <span>{{ errorMessage }}</span>
      </div>
    </div>

    <div class="px-6 pb-6 max-h-[40vh] overflow-y-auto">
      <div class="grid grid-cols-2 gap-3">
        <button *ngFor="let user of availableUsers" (click)="selectUser(user)"
          class="p-4 rounded-xl border-2 text-left transition-all duration-200 hover:shadow-md flex items-center space-x-3"
          [ngClass]="selectedUser === user ? 'border-primary bg-primary/5 ring-2 ring-primary/20' : 'border-gray-100 hover:border-gray-200 text-gray-700'">
          <div
            class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-400 to-primary text-white flex items-center justify-center font-bold text-xs shadow-sm">
            {{ user.charAt(0) }}
          </div>
          <span class="font-medium truncate">{{ user }}</span>
        </button>
      </div>
    </div>

    <div class="p-6 border-t border-gray-100 bg-gray-50">
      <button (click)="joinChat()"
        class="w-full py-3.5 px-6 rounded-xl bg-primary hover:bg-blue-700 text-white font-semibold text-lg shadow-lg shadow-primary/30 transition-all transform hover:-translate-y-0.5 active:scale-95 focus:outline-none focus:ring-4 focus:ring-primary/20 disabled:opacity-50 disabled:cursor-not-allowed">
        Start Chatting
      </button>
    </div>
  </div>
</div>

<!-- Main Chat Interface -->
<div *ngIf="!showUserSelection" class="flex h-screen h-[100dvh] bg-gray-100 overflow-hidden">

  <!-- Sidebar (Chat List) -->
  <aside
    class="fixed inset-y-0 left-0 w-80 sm:w-96 bg-white border-r border-gray-200 flex flex-col z-50 transform transition-transform duration-300 ease-in-out sm:static sm:translate-x-0"
    [ngClass]="showMobileSidebar ? 'translate-x-0' : '-translate-x-full'">
    <!-- Sidebar Header -->
    <header class="bg-[#1e45F3] text-white p-4 flex items-center justify-between shadow-md h-[72px]">
      <div class="flex items-center space-x-3">
        <div
          class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center p-1.5 border border-white/30 backdrop-blur-sm">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-full h-full text-white" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
          </svg>
        </div>
        <h2 class="font-bold text-lg">Chats</h2>
      </div>
      <button (click)="leaveChat()" class="p-2 hover:bg-white/10 rounded-full transition-colors" title="Logout">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg>
      </button>
    </header>

    <!-- Sidebar Search -->
    <div class="p-3 bg-white border-b border-gray-100">
      <div class="relative">
        <input type="text" placeholder="Search or start new chat"
          class="w-full pl-10 pr-4 py-2 bg-gray-100 border-none rounded-lg text-sm focus:ring-2 focus:ring-primary/20 transition-all placeholder-gray-500">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-3.5 top-2.5 text-gray-400" fill="none"
          viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>
    </div>

    <!-- Chat List -->
    <div class="flex-1 overflow-y-auto bg-white">
      <div *ngFor="let chat of chatList" (click)="selectChat(chat)"
        class="flex items-center space-x-4 px-4 py-4 cursor-pointer hover:bg-gray-50 transition-all border-b border-gray-50 group"
        [ngClass]="activeChat === chat ? 'bg-blue-50/50' : ''">
        <div class="relative flex-shrink-0">
          <div [ngClass]="chat === 'General' ? 'bg-[#1e45F3]' : 'bg-gray-200'"
            class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-sm group-hover:scale-105 transition-transform">
            {{ chat === 'General' ? 'G' : chat.charAt(0) }}
          </div>
          <span *ngIf="chat !== 'General'"
            class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></span>
        </div>
        <div class="flex-1 min-w-0">
          <div class="flex justify-between items-baseline mb-0.5">
            <h3 class="text-sm font-semibold text-gray-900 truncate">{{ chat }}</h3>
            <span class="text-[10px] text-gray-400">12:30 PM</span>
          </div>
          <div class="flex justify-between items-center space-x-2">
            <p class="text-xs text-gray-500 truncate group-hover:text-gray-700 transition-colors">
              {{ chat === 'General' ? 'Click to join group chat' : 'Private message with ' + chat }}
            </p>
            <!-- Unread Counter Badge -->
            <span *ngIf="unreadCounts[getTopicForChat(chat)] > 0"
              class="flex-shrink-0 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full shadow-sm animate-pulse">
              {{ unreadCounts[getTopicForChat(chat)] }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </aside>

  <!-- Sidebar Backdrop (Mobile only) -->
  <div *ngIf="showMobileSidebar" (click)="toggleSidebar()"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 sm:hidden transition-opacity duration-300">
  </div>

  <!-- Main Chat Window -->
  <main class="flex-1 flex flex-col bg-white relative h-full overflow-hidden">
    <!-- Chat Header -->
    <header
      class="bg-[#1e45F3] text-white px-4 py-3 flex items-center justify-between shadow-sm z-30 h-[72px] flex-shrink-0">
      <div class="flex items-center space-x-4">
        <!-- Sidebar Toggle (Mobile only) -->
        <button (click)="toggleSidebar()" class="p-2 -ml-2 hover:bg-white/10 rounded-full transition-colors sm:hidden">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>

        <div
          class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center p-1.5 border border-white/30 backdrop-blur-sm shadow-md">
          <div *ngIf="activeChat === 'General'" class="text-xl font-bold">G</div>
          <div *ngIf="activeChat !== 'General'" class="text-xl font-bold">{{ activeChat.charAt(0) }}</div>
        </div>
        <div>
          <h1 class="text-base font-bold leading-tight">{{ activeChat }}</h1>
          <p class="text-[11px] text-blue-100 flex items-center">
            <span class="w-2 h-2 bg-green-400 rounded-full mr-1.5 animate-pulse"></span>
            Online
          </p>
        </div>
      </div>
      <div class="flex items-center space-x-2">
        <button class="p-2 hover:bg-white/10 rounded-full transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </button>
        <button class="p-2 hover:bg-white/10 rounded-full transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
          </svg>
        </button>
      </div>
    </header>

    <!-- Messages Area -->
    <div #messageContainer class="flex-1 px-4 py-4 overflow-y-auto bg-gray-50 relative">
      <!-- Subtle Background Pattern -->
      <div class="absolute inset-0 opacity-[0.05] pointer-events-none"
        style="background-image: url('data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%23000000\' fill-opacity=\'1\'%3E%3Cpath d=\'M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');">
      </div>

      <div class="space-y-4 max-w-4xl mx-auto pt-2 pb-2 relative z-10">
        <div *ngFor="let msg of messages" class="flex w-full group mb-1"
          [ngClass]="msg.isMe ? 'justify-end' : 'justify-start'" [@messageAnimation]>

          <div
            class="relative max-w-[85%] sm:max-w-[70%] text-sm rounded-2xl py-2 px-3 shadow-lg transform transition-all hover:scale-[1.01]"
            [ngClass]="msg.isMe ? 'bg-[#1e45F3] text-white rounded-tr-none' : 'bg-white text-gray-800 rounded-tl-none border border-gray-100'">

            <!-- Delete Message Button (Visible on hover for own messages) -->
            <button *ngIf="msg.isMe" (click)="deleteMessage(msg)"
              class="absolute -left-8 top-1/2 -translate-y-1/2 p-1.5 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all duration-200"
              title="Delete message">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>

            <p *ngIf="!msg.isMe && activeChat === 'General'" class="text-[10px] font-bold text-primary mb-1">{{
              msg.sender }}</p>

            <!-- Image Content -->
            <div *ngIf="isImage(msg.content)" class="mb-1 rounded-lg overflow-hidden border border-gray-100/50">
              <img [src]="getImageContent(msg.content)" alt="Shared Photo"
                class="max-w-full h-auto object-cover max-h-[400px]" loading="lazy">
            </div>

            <!-- Audio Content -->
            <div *ngIf="isAudio(msg.content)" class="mb-1 min-w-[220px] py-1">
              <audio [src]="getAudioContent(msg.content)" controls class="w-full h-8 opacity-90"></audio>
            </div>

            <!-- Text Content -->
            <p *ngIf="!isImage(msg.content) && !isAudio(msg.content)"
              class="px-1 whitespace-pre-wrap leading-relaxed text-[15px]">{{ msg.content }}</p>

            <div class="flex items-center justify-end space-x-1.5 mt-1 opacity-70">
              <span class="text-[9px] min-w-fit uppercase tracking-tighter">
                {{ msg.timestamp | date:'shortTime' }}
              </span>
              <svg *ngIf="msg.isMe" class="w-3 h-3 text-blue-200" viewBox="0 0 16 11" fill="none">
                <path d="M11.5 0.5L4.5 7.5L1.5 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                  stroke-linejoin="round" />
                <path d="M15 0.5L8 7.5L5 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                  stroke-linejoin="round" />
              </svg>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Input Footer (Floating/Sticky Fix for Mobile) -->
    <footer
      class="bg-[#1e45F3] px-4 py-4 border-t border-white/10 shadow-[0_-4px_15px_rgba(0,0,0,0.1)] pb-[calc(1rem+safe-area-inset-bottom)] fixed bottom-0 left-0 right-0 sm:sticky sm:z-30 z-40 flex-shrink-0">
      <div class="max-w-4xl mx-auto flex items-center space-x-3">
        <!-- Attach -->
        <button (click)="triggerFileInput()"
          class="p-2 text-white/80 hover:text-white hover:bg-white/10 rounded-full transition-all">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-45" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
          </svg>
        </button>
        <input type="file" #fileInput (change)="handleFileInput($event)" hidden accept="image/*">

        <!-- Input Wrapper -->
        <div class="flex-1 relative">
          <!-- Recording UI -->
          <div *ngIf="isRecording"
            class="absolute inset-0 z-10 flex items-center justify-between bg-white rounded-full px-4 border border-red-200 shadow-sm transition-all animate-fade-in">
            <div class="flex items-center space-x-3 text-red-600 font-bold text-sm tracking-wide">
              <span class="w-2.5 h-2.5 rounded-full bg-red-600 animate-ping"></span>
              <span>RECORDING {{ recordingTime }}</span>
            </div>
            <div class="flex items-center space-x-1">
              <button (click)="cancelRecording()"
                class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
              <button (click)="stopRecording()"
                class="p-2 bg-red-600 text-white rounded-full shadow-lg transform active:scale-95 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path
                    d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 0010 16h.01a1 1 0 00.725-.3l5-4a1 1 0 00.001-1.414l-4.286-4.286a1 1 0 00-1.414.001l-1.429 1.428a1 1 0 000 1.414l1.636 1.636-3.536 1.768-3.535-7.071L10.894 2.553z" />
                </svg>
              </button>
            </div>
          </div>

          <!-- Standard Input -->
          <input type="text" [(ngModel)]="newMessage" (keyup.enter)="sendMessage()"
            [placeholder]="'Message ' + activeChat + '...'"
            class="w-full px-5 py-3 bg-white/10 text-white placeholder-white/50 border-white/20 rounded-full focus:bg-white focus:text-gray-900 focus:placeholder-gray-400 transition-all outline-none focus:ring-0 shadow-inner" />
        </div>

        <!-- Mic/Send -->
        <div class="flex-shrink-0">
          <!-- Mic (Hidden if typing or recording) -->
          <button *ngIf="!newMessage.trim() && !isRecording" (click)="startRecording()"
            class="p-3 bg-white/20 text-white rounded-full hover:bg-white/30 transition-all active:scale-90 shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
          </button>

          <!-- Send (if typing) -->
          <button *ngIf="newMessage.trim() && !isRecording" (click)="sendMessage()"
            class="p-3 bg-white text-[#1e45F3] rounded-full hover:bg-blue-50 transition-all active:scale-90 shadow-xl">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-90" viewBox="0 0 20 20"
              fill="currentColor">
              <path
                d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 0010 16h.01a1 1 0 00.725-.3l5-4a1 1 0 00.001-1.414l-4.286-4.286a1 1 0 00-1.414.001l-1.429 1.428a1 1 0 000 1.414l1.636 1.636-3.536 1.768-3.535-7.071L10.894 2.553z" />
            </svg>
          </button>
        </div>
      </div>
    </footer>
  </main>
</div>